#!/usr/bin/env bash
CHECK_MARK="\033[0;32m\xE2\x9C\x94\033[0m"
source $(dirname "$0")/custom.conf

dockerNetworkExits=$(docker network ls -q -f name="nginx-proxy")

echo -e "\e[1;32mStep 1/2 - Building"
#git
if [ -n "$gitRepoLink" ]; then
gitConfigLink=${gitRepoLink#*git clone}
echo -e "\e[1;33mUsing git link"$gitConfigLink""
fi

echo -n -e  "\e[1;37mPHP version: $phpVersion \n"
echo -n -e "\e[1;37mDatabase name: $mysqlDatabaseName\n"
        cd db
        dumpName=$(ls -t *.sql | head -1)
        cd ../
echo -n -e "\e[1;37mDatabase file to import: $dumpName\n"

cp ./build/docker-compose.yml ./docker-compose.yml

sed -i "s/{{PROJECT_FOLDER}}/$projectFolder/g" ./docker-compose.yml
sed -i "s/{{PROJECT_NAME}}/$projectName/g" ./docker-compose.yml
sed -i "s/{{PROJECT_NUMBER}}/$projectNumber/g" ./docker-compose.yml
sed -i "s/{{PHP_VERSION}}/$phpVersion/g" ./docker-compose.yml

cp ./build/default.conf ./nginx/
sed -i "s/{{PROJECT_NAME}}/$projectName/g" ./nginx/default.conf
sed -i "s>{{PROJECT_NUMBER}}>$projectNumber>g" ./nginx/default.conf

cp ./build/exec ./bin/exec
sed -i "s/{{PROJECT_NAME}}/$projectName/g" ./bin/exec
sed -i "s/{{PROJECT_FOLDER}}/$projectFolder/g" ./bin/exec

cp ./build/install ./bin/install
sed -i "s/{{DUMP_NAME}}/$dumpName/g" ./bin/install
sed -i "s/{{DATABASE_NAME}}/$mysqlDatabaseName/g" ./bin/install
sed -i "s/{{PROJECT_NAME}}/$projectName/g" ./bin/install
sed -i "s>{{GIT_REPO}}>$gitConfigLink>g" ./bin/install
sed -i "s>{{PROJECT_FOLDER}}>$projectFolder>g" ./bin/install
sed -i "s>{{PROJECT_NUMBER}}>$projectNumber>g" ./bin/install
sed -i "s/{{DB_CONTAINER}}/$dbContainer/g" ./bin/install

cp ./build/docker-compose-shared.yml ./docker-compose-shared.yml
sed -i "s/{{NGINX_PROXY}}/$nginxProxy/g" ./docker-compose-shared.yml
sed -i "s/{{DB_CONTAINER}}/$dbContainer/g" ./docker-compose-shared.yml
sed -i "s/{{MAILHOG_CONTAINER}}/$mhContainer/g" ./docker-compose-shared.yml


mkdir -p ./magento/app/etc
mkdir -p ./magento/pub
mkdir -p ./magento/bin
cp ./bin/exec ./magento/bin/
cp -f ./build/magento/env.php ./magento/app/etc
sed -i "s/{{DATABASE_NAME}}/$mysqlDatabaseName/g" ./magento/app/etc/env.php
sed -i "s/{{PROJECT_NAME}}/$projectName/g" ./magento/app/etc/env.php

cp -f ./build/magento/index.php ./magento/pub/index.php
cp -f ./build/magento/config.php ./magento/app/etc
cp ./build/php_ini ./php/php.ini
sed -i "s/{{PROJECT_NAME}}/$projectName/g" ./php/php.ini

cp ./build/php_bashrc ./php/bashrc

chmod +x ./bin/*

echo -e "\e[1;32mRunning bin/install"
echo -e "\e[1;32mStep2/2"

./bin/install