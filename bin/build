#!/usr/bin/env bash

getUserInput() {
    local userInput=''
    read userInput
    if [ -z "$userInput" ]; then
        userInput="$1"
    fi
    echo $userInput
}

echo -n "[Optional] Git repository URL: "
gitRepo=$(getUserInput "")

echo -n "[DEFAULT=html] Project source folder: "
projectFolder=$(getUserInput "magento-empty")

echo -n "[DEFAULT=m2project] Project name: "
projectName=$(getUserInput "m2project")

echo -n "[DEFAULT=8080] Port to access nginx: "
nginxPort=$(getUserInput "8080")

echo -n "[DEFAULT=13306] Port to access mysql: "
mysqlPort=$(getUserInput "13306")

echo -n "[DEFAULT=magento] Database name: "
mysqlDatabaseName=$(getUserInput "magento")

echo -n "[DEFAULT=8025] Mailhog interface port: "
mailhogPort=$(getUserInput "1025")

echo "If you want to import database dump during installation process then copy file to db directory and type its name. Leave empty otherwise."
echo -n "Dump filename: "
dumpName=$(getUserInput "")

cp ./build/docker-compose.yml ./docker-compose.yml
pwd
sed -i "s/{{PROJECT_FOLDER}}/$projectFolder/g" ./docker-compose.yml
sed -i "s/{{PROJECT_NAME}}/$projectName/g" ./docker-compose.yml
sed -i "s/{{NGINX_PORT_EXPOSE}}/$nginxPort/g" ./docker-compose.yml
sed -i "s/{{DB_PORT_EXPOSE}}/$mysqlPort/g" ./docker-compose.yml
sed -i "s/{{MAILHOG_PORT_EXPOSE}}/$mailhogPort/g" ./docker-compose.yml

cp ./build/php_Dockerfile ./php/Dockerfile

sed -i "s/{{PHP_VERSION}}/$phpVersion/g" ./php/Dockerfile

cp ./build/default.conf ./nginx/
sed -i "s/{{PROJECT_NAME}}/$projectName/g" ./nginx/default.conf

cp ./build/exec ./bin/exec
sed -i "s/{{PROJECT_NAME}}/$projectName/g" ./bin/exec

cp ./build/install ./bin/install
sed -i "s/{{DUMP_NAME}}/$dumpName/g" ./bin/install
sed -i "s/{{DATABASE_NAME}}/$mysqlDatabaseName/g" ./bin/install
sed -i "s/{{PROJECT_NAME}}/$projectName/g" ./bin/install
sed -i "s>{{GIT_REPO}}>$gitRepo>g" ./bin/install

cp ./build/php_ini ./php/php.ini
sed -i "s/{{PROJECT_NAME}}/$projectName/g" ./php/php.ini

cp ./build/php_bashrc ./php/bashrc

chmod +x ./bin/*

echo -e "\e[32m Finished building without errors."